# Архитектура проекта

## Обзор

Проект представляет собой образовательную платформу с раздельной архитектурой: FastAPI backend и React frontend. Система спроектирована для масштабируемости, производительности и удобства разработки.

## Технологический стек

### Backend

**FastAPI** - современный асинхронный веб-фреймворк для Python
- Высокая производительность благодаря асинхронности (ASGI)
- Автоматическая генерация OpenAPI/Swagger документации
- Встроенная валидация данных через Pydantic
- Type hints для лучшей поддержки IDE

**SQLAlchemy (async)** - ORM для работы с базой данных
- Асинхронные запросы для лучшей производительности
- Поддержка сложных запросов и отношений
- Миграции через Alembic (можно добавить)
- Типобезопасность через Mapped типы

**PostgreSQL** - реляционная база данных
- Надежность и ACID гарантии
- Поддержка JSON для гибких структур данных
- Отличная производительность для сложных запросов
- Широкое распространение и хорошая документация

**Redis** - in-memory хранилище данных
- Кэширование для ускорения запросов
- Хранение сессий (можно расширить)
- Очереди задач (можно добавить Celery)
- Pub/Sub для real-time уведомлений (можно расширить)

**Pydantic** - валидация и сериализация данных
- Автоматическая валидация входных данных
- Сериализация моделей в JSON
- Type safety на уровне схем
- Интеграция с FastAPI

**JWT (python-jose)** - аутентификация
- Stateless аутентификация
- Access и Refresh токены
- Безопасное хранение на клиенте
- Легкое масштабирование

**bcrypt (passlib)** - хеширование паролей
- Безопасное хранение паролей
- Защита от rainbow table атак
- Медленное хеширование для защиты от brute-force

**structlog** - структурированное логирование
- JSON формат для удобного парсинга
- Контекстная информация в каждом логе
- Интеграция с системами мониторинга
- Удобная отладка в production

### Frontend

**React + TypeScript** - UI фреймворк
- Компонентный подход
- Type safety через TypeScript
- Большое сообщество и экосистема

**Vite** - сборщик и dev-сервер
- Быстрая разработка (HMR)
- Оптимизированная сборка
- Современный tooling

**shadcn/ui** - компоненты UI
- Доступные компоненты
- Кастомизируемый дизайн
- TypeScript поддержка

## Архитектурные решения

### 1. Асинхронность

Все операции с БД и внешними сервисами асинхронные:
- Позволяет обрабатывать больше запросов одновременно
- Не блокирует event loop
- Лучшая утилизация ресурсов сервера

### 2. Репозиторный паттерн

Разделение доступа к данным и бизнес-логики:
- Легкое тестирование (можно мокировать репозитории)
- Переиспользование кода
- Изоляция SQLAlchemy от бизнес-логики

### 3. Dependency Injection

FastAPI встроенный DI через Depends:
- Автоматическое управление зависимостями
- Легкое тестирование
- Чистый код без глобальных состояний

### 4. Схемы Pydantic

Отдельные схемы для запросов и ответов:
- Валидация на входе
- Контроль структуры ответов
- Автоматическая документация API

### 5. Хранение медиафайлов в S3

**Yandex Object Storage** (S3-совместимое):
- Масштабируемость - неограниченное хранилище
- Надежность - репликация и backup
- Производительность - CDN интеграция
- Стоимость - платите только за использование
- Безопасность - изолированное хранилище
- Отделение статики от приложения - легче масштабировать backend

## Структура проекта

```
back/
├── app/
│   ├── api/          # API endpoints (роутеры)
│   ├── core/         # Настройки, безопасность, middleware
│   ├── db/           # Модели БД и сессии
│   ├── repo/         # Репозитории для доступа к данным
│   ├── schemas/      # Pydantic схемы
│   ├── services/     # Бизнес-логика
│   └── utils/        # Утилиты (deps, helpers)
└── main.py           # Точка входа приложения
```

## Потоки данных

1. **Аутентификация:**
   - Клиент → POST /api/auth/login
   - Backend проверяет credentials
   - Возвращает JWT токены
   - Клиент использует access_token для последующих запросов

2. **Запрос данных:**
   - Клиент → GET /api/... (с токеном)
   - Middleware проверяет токен
   - Endpoint → Service → Repository → DB
   - Ответ через Pydantic схемы

3. **Загрузка файлов:**
   - Клиент → POST /api/assignments/{id}/submissions (multipart)
   - Backend получает файл
   - Загружает в Yandex S3
   - Сохраняет URL в БД
   - Возвращает информацию о файле

## Безопасность

- Пароли хешируются через bcrypt
- JWT токены с коротким временем жизни
- Refresh токены для обновления
- CORS настроен для фронтенда
- Валидация всех входных данных
- SQL injection защита через SQLAlchemy

## Масштабируемость

- Асинхронная архитектура позволяет обрабатывать много запросов
- Redis для кэширования и снижения нагрузки на БД
- S3 для хранения файлов - не нагружает сервер
- Stateless backend - легко горизонтально масштабировать
- Docker контейнеризация для простого деплоя

## Мониторинг и логирование

- Структурированное логирование (JSON)
- Логирование всех запросов
- Обработка ошибок с детальной информацией
- Health check endpoint для мониторинга

## Развертывание

- Docker Compose для локальной разработки
- Отдельные контейнеры для каждого сервиса
- Volumes для персистентности данных
- Health checks для автоматического перезапуска

## Настройка Yandex Object Storage

### 1. Создание бакета

1. Зайдите в [Yandex Cloud Console](https://console.cloud.yandex.ru/)
2. Перейдите в Object Storage
3. Создайте новый бакет
4. Настройте публичный доступ (если нужен) или используйте presigned URLs

### 2. Получение ключей доступа

1. В Yandex Cloud Console перейдите в раздел "Сервисные аккаунты"
2. Создайте сервисный аккаунт или используйте существующий
3. Назначьте роль `storage.editor` или `storage.admin`
4. Создайте статический ключ доступа
5. Сохраните Access Key ID и Secret Access Key

### 3. Настройка переменных окружения

Добавьте в `.env` файл:

```env
S3_ENDPOINT=https://storage.yandexcloud.net
S3_ACCESS_KEY_ID=your-access-key-id
S3_SECRET_ACCESS_KEY=your-secret-access-key
S3_BUCKET_NAME=your-bucket-name
S3_REGION=ru-central1
```

### 4. Структура хранения в S3

Файлы хранятся в следующей структуре:
```
bucket-name/
├── submissions/
│   └── {assignment_id}/
│       └── {submission_id}/
│           └── {uuid}.{ext}
├── materials/
│   └── {course_id}/
│       └── {module_id}/
│           └── {uuid}.{ext}
└── profile/
    └── {user_id}/
        └── {uuid}.{ext}
```

### 5. Безопасность

- Используйте presigned URLs для временного доступа к файлам
- Настройте CORS политику в бакете для доступа с фронтенда
- Ограничьте права сервисного аккаунта минимально необходимыми
- Используйте разные бакеты для dev/staging/production

## Преимущества использования S3

1. **Масштабируемость** - неограниченное хранилище
2. **Надежность** - автоматическая репликация и backup
3. **Производительность** - CDN интеграция для быстрой доставки
4. **Стоимость** - платите только за использование
5. **Безопасность** - изолированное хранилище с контролем доступа
6. **Отделение статики** - не нагружает backend сервер

